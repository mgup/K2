<% content_for :title, 'Подразделения' %>

<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script>
  google.load('visualization', '1', { packages:['orgchart'] });
  google.setOnLoadCallback(drawChart);
  function drawChart() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Название');
    data.addColumn('string', 'Главное подразделение');

    data.addRows([
      <% @departments.each do |d| %>
        [
          {
            v: '<%= d.id %>',
            f: '<%=j render partial: 'chart_node', locals: { department: d } %>'
          },
          '<%= d.main_department.present? ? d.main_department.id : '' %>'
        ],
      <% end %>
    ]);

    var chart = new google.visualization.OrgChart(
      document.getElementById('departments_chart')
    );
    chart.draw(data, {
      nodeClass: 'org-chart-node',
      selectedNodeClass: 'org-chart-selected-node',
      allowHtml: true
    });
  }
</script>

<div id="departments_chart">
  Загрузка списка подразделений...
</div>
